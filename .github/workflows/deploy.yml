name: Build and Update K8s

on:
  push:
    branches: [ "master" ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      # 1. Checkout App Code
      - uses: actions/checkout@v3

      # 2. Log in to Docker Hub (Ensure secrets DOCKER_USERNAME & DOCKER_PASSWORD exist)
      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 3. Build and Push Docker Image
      - name: Build and Push
        run: |
          docker build -t nnikolovskii/gc-backend:${{ github.sha }} .
          docker push nnikolovskii/gc-backend:${{ github.sha }}

      # 4. Update the Kubernetes Repo
      - name: Update values.yaml in K8s Repo
        uses: actions/checkout@v3
        with:
          repository: nnikolovskii/kubernetes  # <--- CONFIRM THIS NAME
          token: ${{ secrets.K8S_REPO_TOKEN }}
          path: k8s-repo

      - name: Commit new tag
        run: |
          cd k8s-repo
          # Install yq to edit YAML safely
          wget https://github.com/mikefarah/yq/releases/download/v4.34.1/yq_linux_amd64 -O /usr/bin/yq && chmod +x /usr/bin/yq
          
          # Update the tag for backend
          yq -i ".backend.image.tag = \"${{ github.sha }}\"" charts/gc-app/values.yaml
          
          # Git Commit & Push
          git config user.name "CI Bot"
          git config user.email "ci@bot.com"
          git add charts/gc-app/values.yaml
          git commit -m "Update backend image to ${{ github.sha }}"
          git push